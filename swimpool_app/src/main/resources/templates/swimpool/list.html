<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (SPA)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/swimpool-list.css">
    <script src="/js/jquery-3.7.1.min.js"></script>
</head>

<body>
<div class="wrap">
    <nav class="top-nav">
        <button class="nav-btn" data-view="swimpool">ğŸŠ ìˆ˜ì˜ì¥ ëª©ë¡</button>
        <button class="nav-btn" data-view="user">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
    </nav>

    <div id="swimpoolSection" class="content-section">
        <div class="search-bar">
            <input type="text" id="swimpoolSearchInput" placeholder="ìˆ˜ì˜ì¥ ì´ë¦„, ì£¼ì†Œ ë“± ê²€ìƒ‰">
            <button id="swimpoolSearchBtn">ğŸ” ê²€ìƒ‰</button>
            <button id="swimpoolResetBtn">ì „ì²´ëª©ë¡</button>
        </div>
        <div class="info-card">
            ìˆ˜ì˜ì¥ ì •ë³´ ëª©ë¡
            <button id="showAddSwimpoolModalButton" class="nav-btn" style="float: right; font-size: 14px; padding: 5px 10px;">ìˆ˜ì˜ì¥ ì¶”ê°€</button>
        </div>
        <div id="swimpoolListPrint" class="list-cards"></div>
        <div id="swimpoolPagination" class="pagination-container"></div>
    </div>

    <div id="userSection" class="content-section" style="display: none;">
        <div class="search-bar">
            <input type="text" id="userSearchInput" placeholder="ì‚¬ìš©ì ì´ë¦„, ì•„ì´ë””, ì´ë©”ì¼ ë“± ê²€ìƒ‰">
            <button id="userSearchBtn">ğŸ” ê²€ìƒ‰</button>
            <button id="userResetBtn">ì „ì²´ëª©ë¡</button>
        </div>
        <div class="info-card">
            ì‚¬ìš©ì ì •ë³´ ëª©ë¡
            <button id="showRegisterBtn" class="nav-btn" style="float: right; font-size: 14px; padding: 5px 10px;">ì‹ ê·œ íšŒì› ë“±ë¡</button>
        </div>
        <div id="userListPrint" class="list-cards"></div>
        <div id="userPagination" class="pagination-container"></div>
    </div>

    <div id="registerSection" class="content-section" style="display: none;">
        <div class="form-container">
            <h1>ì‹ ê·œ íšŒì› ë“±ë¡</h1>
            <form id="registerForm">
                <div class="form-group"><label for="regName">ì´ë¦„</label><input type="text" id="regName" required></div>
                <div class="form-group"><label for="regUsername">ì•„ì´ë””</label><input type="text" id="regUsername" required></div>
                <div class="form-group"><label for="regPassword">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="regPassword" required></div>
                <div class="form-group"><label for="regPasswordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="regPasswordConfirm" required></div>
                <div class="form-group"><label for="regEmail">ì´ë©”ì¼</label><input type="email" id="regEmail" required></div>
                <div class="form-group"><label for="regPhoneNumber">ì „í™”ë²ˆí˜¸</label><input type="tel" id="regPhoneNumber"></div>
                <button type="submit" class="submit-btn">ë“±ë¡í•˜ê¸°</button>
            </form>
        </div>
    </div>
</div> <div id="swimpoolModal" class="modal_popup" style="display: none;">
    <h1>ìˆ˜ì˜ì¥ ì •ë³´</h1>
    <div><label for="inSwimpoolName">ì´ë¦„ : </label><input type="text" id="inSwimpoolName" /></div>
    <div><label for="inSwimpoolPhoneNumber">ë²ˆí˜¸ : </label><input type="text" id="inSwimpoolPhoneNumber" /></div>
    <div><label for="inSwimpoolAddr">ì£¼ì†Œ : </label><input type="text" id="inSwimpoolAddr" /></div>
    <div><label for="inSwimpoolLaneType">ë ˆì¸íƒ€ì… : </label>
        <select id="inSwimpoolLaneType">
            <option value="L25M">L25M</option>
            <option value="L50M">L50M</option>
        </select>
    </div>
    <div><label for="inSwimpoolLanes">ë ˆì¸ìˆ˜ : </label><input type="number" id="inSwimpoolLanes" /></div>
    <div style="margin-top: 12px;">
        <button id="swimpoolModalActionBtn">ì €ì¥</button>
        <button class="modalCloseButton">ë‹«ê¸°</button>
    </div>
</div>

<div id="userModal" class="modal_popup" style="display: none;">
    <h1>ì‚¬ìš©ì ì •ë³´</h1>
    <input type="hidden" id="inUserId">
    <div><label>ì´ë¦„ : </label><input type="text" id="inUserName" /></div>
    <div><label>ì•„ì´ë”” : </label><input type="text" id="inUserUsername" readonly /></div>
    <div><label>ì´ë©”ì¼ : </label><input type="text" id="inUserEmail" /></div>
    <div><label>ì „í™”ë²ˆí˜¸ : </label><input type="text" id="inUserPhoneNumber" /></div>
    <div><label>ê¶Œí•œ : </label>
        <select id="inUserRole">
            <option value="ROLE_USER">ì¼ë°˜ì‚¬ìš©ì</option>
            <option value="ROLE_ADMIN">ê´€ë¦¬ì</option>
        </select>
    </div>
    <div style="margin-top: 12px;">
        <button id="userModalActionBtn">ìˆ˜ì •ì™„ë£Œ</button>
        <button class="modalCloseButton">ë‹«ê¸°</button>
    </div>
</div>

<div class="modal_background" style="display: none;"></div>


<script>
    $(document).ready(function(){
        // =================================================================
        // SPA í™”ë©´ ì „í™˜ ë¡œì§ (ê°€ì¥ ì¤‘ìš”!)
        // =================================================================
        function switchView(viewName) {
            $('.content-section').hide();
            $('.nav-btn').removeClass('active');

            if (viewName === 'swimpool') {
                $('#swimpoolSection').show();
                $('.nav-btn[data-view="swimpool"]').addClass('active');
                loadSwimpoolList(1);
            } else if (viewName === 'user') {
                $('#userSection').show();
                $('.nav-btn[data-view="user"]').addClass('active');
                loadUserList(1);
            } else if (viewName === 'register') {
                $('#registerSection').show();
                $('.nav-btn[data-view="user"]').addClass('active');
                $('#registerForm')[0].reset();
            }
        }

        // =================================================================
        // ìˆ˜ì˜ì¥ ê´€ë¦¬ (Swimpool) ê¸°ëŠ¥
        // =================================================================
        function loadSwimpoolList(page) {
            const search = $('#swimpoolSearchInput').val() || '';
            $.ajax({
                url: '/api/v1/swimpool/list',
                type: 'GET',
                data: { search: search, page: page, row: 9 }
            }).done(result => {
                renderSwimpoolList(result.data.list || []);
                renderSwimpoolPagination(result.data);
            }).fail(() => alert("ìˆ˜ì˜ì¥ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨"));
        }

        function renderSwimpoolList(list) {
            const container = $("#swimpoolListPrint").empty();
            list.forEach(item => container.append(makeSwimpoolRow(item)));

            container.off('click').on('click', 'button', function() {
                const id = $(this).data('id');
                if ($(this).hasClass('btnSwimpoolEdit')) {
                    getSwimpoolForEdit(id);
                } else if ($(this).hasClass('btnSwimpoolDel')) {
                    if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) deleteSwimpool(id);
                }
            });
        }

        function makeSwimpoolRow(item) {
            return `
        <div class="data-row"><div class="card h-100"><div class="card-body">
            <div>ì´ë¦„ : <b>${item.name}</b></div>
            <div>ì „í™” : <span style="color:#1575e0">${item.phoneNumber}</span></div>
            <div>í˜•íƒœ : ${item.laneType} / ${item.lanes} ë ˆì¸</div>
            <button class="btnSwimpoolEdit" data-id="${item.id}">ìˆ˜ì •</button>
            <button class="btnSwimpoolDel" data-id="${item.id}">ì‚­ì œ</button>
        </div></div></div>`;
        }

        function renderSwimpoolPagination(data) {
            const { totalPages, page: curPage } = data;
            const container = $("#swimpoolPagination").empty();
            if (!totalPages || totalPages < 2) return;

            let html = '';
            if (curPage > 1) html += `<button class="page-btn" data-page="${curPage - 1}">â€¹</button>`;
            for (let i = Math.max(1, curPage - 2); i <= Math.min(totalPages, curPage + 2); i++) {
                html += `<button class="page-btn${i === curPage ? ' cur' : ''}" data-page="${i}">${i}</button>`;
            }
            if (curPage < totalPages) html += `<button class="page-btn" data-page="${curPage + 1}">â€º</button>`;

            container.html(html);
            container.find(".page-btn").on("click", function() {
                loadSwimpoolList(parseInt($(this).data("page")));
            });
        }

        function openSwimpoolModal(mode, data = null) {
            $('#swimpoolModal h1').text(mode === 'insert' ? 'ìˆ˜ì˜ì¥ ì…ë ¥' : 'ìˆ˜ì˜ì¥ ì •ë³´ ìˆ˜ì •');
            $('#swimpoolModalActionBtn').text(mode === 'insert' ? 'ë“±ë¡' : 'ìˆ˜ì •ì™„ë£Œ').data("mode", mode);

            if (data) {
                $('#swimpoolModalActionBtn').data("id", data.id);
                $('#inSwimpoolName').val(data.name);
                $('#inSwimpoolPhoneNumber').val(data.phoneNumber);
                $('#inSwimpoolAddr').val(data.addr);
                $('#inSwimpoolLaneType').val(data.laneType);
                $('#inSwimpoolLanes').val(data.lanes);
            } else {
                $('#inSwimpoolName, #inSwimpoolPhoneNumber, #inSwimpoolAddr, #inSwimpoolLanes').val('');
                $('#inSwimpoolLaneType').val('L25M');
            }
            $('#swimpoolModal, .modal_background').fadeIn(200);
        }

        function handleSwimpoolAction() {
            const mode = $('#swimpoolModalActionBtn').data("mode");
            const id = $('#swimpoolModalActionBtn').data("id");
            const data = {
                name: $("#inSwimpoolName").val(),
                phoneNumber: $("#inSwimpoolPhoneNumber").val(),
                addr: $("#inSwimpoolAddr").val(),
                laneType: $("#inSwimpoolLaneType").val(),
                lanes: $("#inSwimpoolLanes").val()
            };
            const isInsert = mode === 'insert';
            const url = isInsert ? '/api/v1/swimpool' : `/api/v1/swimpool/${id}`;
            const type = isInsert ? 'POST' : 'PATCH';

            $.ajax({ url, type, contentType: 'application/json', data: JSON.stringify(data) })
                .done(() => {
                    alert(`${isInsert ? 'ë“±ë¡' : 'ìˆ˜ì •'} ì„±ê³µ!`);
                    closeModal();
                    loadSwimpoolList(1);
                }).fail(() => alert(`${isInsert ? 'ë“±ë¡' : 'ìˆ˜ì •'} ì‹¤íŒ¨!`));
        }

        function getSwimpoolForEdit(id) { $.get('/api/v1/swimpool/' + id).done(res => openSwimpoolModal('edit', res.data)); }
        function deleteSwimpool(id) { $.ajax({ url: '/api/v1/swimpool/' + id, type: 'DELETE' }).done(() => { alert("ì‚­ì œ ì„±ê³µ!"); loadSwimpoolList(1); }); }

        // =================================================================
        // ì‚¬ìš©ì ê´€ë¦¬ (User) ê¸°ëŠ¥
        // =================================================================
        function loadUserList(page) {
            const search = $('#userSearchInput').val() || '';
            $.ajax({
                url: '/api/v1/user/list',
                type: 'GET',
                data: { search, page, row: 9 }
            }).done(result => {
                renderUserList(result.data.list || []);
                renderUserPagination(result.data);
            }).fail(() => alert("ì‚¬ìš©ì ëª©ë¡ ë¡œë”© ì‹¤íŒ¨"));
        }

        function renderUserList(list) {
            const container = $("#userListPrint").empty();
            list.forEach(item => container.append(makeUserRow(item)));

            container.off('click').on('click', 'button', function() {
                const id = $(this).data('id');
                if ($(this).hasClass('btnUserEdit')) {
                    getForUserEdit(id);
                } else if ($(this).hasClass('btnUserDel')) {
                    if (confirm("ì •ë§ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) deleteUser(id);
                }
            });
        }

        function makeUserRow(item) {
            const roleText = item.role === 'ROLE_ADMIN' ? 'ê´€ë¦¬ì' : 'ì¼ë°˜ì‚¬ìš©ì';
            return `
        <div class="data-row"><div class="card h-100"><div class="card-body">
            <div>ì´ë¦„: <b>${item.name}</b> (${item.username})</div>
            <div>ì´ë©”ì¼: <span style="color:#1575e0">${item.email}</span></div>
            <div>ê¶Œí•œ: ${roleText}</div>
            <button class="btnUserEdit" data-id="${item.id}">ìˆ˜ì •</button>
            <button class="btnUserDel" data-id="${item.id}">ì‚­ì œ</button>
        </div></div></div>`;
        }

        function renderUserPagination(data) {
            const { totalPages, page: curPage } = data;
            const container = $("#userPagination").empty();
            if (!totalPages || totalPages < 2) return;

            let html = '';
            if (curPage > 1) html += `<button class="page-btn" data-page="${curPage - 1}">â€¹</button>`;
            for (let i = Math.max(1, curPage - 2); i <= Math.min(totalPages, curPage + 2); i++) {
                html += `<button class="page-btn${i === curPage ? ' cur' : ''}" data-page="${i}">${i}</button>`;
            }
            if (curPage < totalPages) html += `<button class="page-btn" data-page="${curPage + 1}">â€º</button>`;

            container.html(html);
            container.find(".page-btn").on("click", function() {
                loadUserList(parseInt($(this).data("page")));
            });
        }

        function getForUserEdit(id) {
            $.get('/api/v1/user/' + id).done(result => {
                const user = result.data;
                $("#inUserId").val(user.id);
                $("#inUserName").val(user.name);
                $("#inUserUsername").val(user.username);
                $("#inUserEmail").val(user.email);
                $("#inUserPhoneNumber").val(user.phoneNumber);
                $("#inUserRole").val(user.role);
                $('#userModal, .modal_background').fadeIn(200);
            }).fail(() => alert("ì‚¬ìš©ì ì •ë³´ ë¡œë”© ì‹¤íŒ¨"));
        }

        function updateUser() {
            const id = $("#inUserId").val();
            const data = {
                id,
                name: $("#inUserName").val(),
                email: $("#inUserEmail").val(),
                phoneNumber: $("#inUserPhoneNumber").val(),
                role: $("#inUserRole").val()
            };
            $.ajax({
                url: '/api/v1/user/' + id,
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify(data)
            }).done(() => {
                alert("ìˆ˜ì • ì„±ê³µ");
                closeModal();
                loadUserList(1);
            }).fail(() => alert("ìˆ˜ì • ì‹¤íŒ¨"));
        }

        function deleteUser(id) {
            $.ajax({ url: '/api/v1/user/' + id, type: 'DELETE' })
                .done(() => {
                    alert("ì‚­ì œ ì„±ê³µ");
                    loadUserList(1);
                }).fail(() => alert("ì‚­ì œ ì‹¤íŒ¨"));
        }

        // =================================================================
        // íšŒì›ê°€ì… (Register) ê¸°ëŠ¥
        // =================================================================
        function registerUser() {
            const password = $('#regPassword').val();
            if (password !== $('#regPasswordConfirm').val()) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            const userData = {
                name: $('#regName').val(),
                username: $('#regUsername').val(),
                password,
                email: $('#regEmail').val(),
                phoneNumber: $('#regPhoneNumber').val()
            };
            $.ajax({
                url: '/api/v1/user/register',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(userData)
            }).done(() => {
                alert("íšŒì›ê°€ì… ì„±ê³µ!");
                switchView('user');
            }).fail(() => alert("íšŒì›ê°€ì… ì‹¤íŒ¨. ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼ ì¤‘ë³µ ê°€ëŠ¥"));
        }

        // =================================================================
        // ê³µìš© ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        // =================================================================
        function closeModal() {
            $('.modal_popup, .modal_background').fadeOut(120);
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        $('.nav-btn').on('click', function() { switchView($(this).data('view')); });
        $(document).on('click', '#showRegisterBtn', () => switchView('register'));

        // ìˆ˜ì˜ì¥ ì´ë²¤íŠ¸
        $('#swimpoolSearchBtn').on('click', () => loadSwimpoolList(1));
        $('#swimpoolResetBtn').on('click', () => { $('#swimpoolSearchInput').val(''); loadSwimpoolList(1); });
        $('#showAddSwimpoolModalButton').on('click', () => openSwimpoolModal('insert'));
        $('#swimpoolModalActionBtn').on('click', handleSwimpoolAction);

        // ì‚¬ìš©ì ì´ë²¤íŠ¸
        $('#userSearchBtn').on('click', () => loadUserList(1));
        $('#userResetBtn').on('click', () => { $('#userSearchInput').val(''); loadUserList(1); });
        $('#userModalActionBtn').on('click', updateUser);

        // íšŒì›ê°€ì… í¼ ì œì¶œ ì´ë²¤íŠ¸
        $('#registerForm').on('submit', e => {
            e.preventDefault();
            registerUser();
        });

        // ê³µìš© ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        $('.modalCloseButton').on('click', closeModal);

        // ì´ˆê¸° í™”ë©´ ë¡œë“œ
        switchView('swimpool');
    });
</script>
</body>
</html>